<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map - Buses & Stops</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        .route-badge { display:inline-block; background:#0078ff; color:white; padding:2px 6px; margin:2px; border-radius:4px; font-size:12px; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    const map = L.map('map').setView([61.4971, 23.7526], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const busMarkers = new Map();
    const busPrevPos = new Map();
    const stopMarkers = new Map();

    <!-- dummy user location -->
    let userLocation = { 
    lat: 61.5007, 
    lng: 23.7597
    };

    const userMarker = L.marker([userLocation.lat, userLocation.lng], { title: "You (dummy)" }).addTo(map);
    userMarker.bindPopup("Dummy user location");


    function occupancyColor(occ) {
        if (occ == null) return "#00FF00";
        if (occ < 40) return "#00FF00";
        if (occ < 70) return "#FFD700";
        return "#FF0000";
    }

    const activeAnimations = new Map();
    function animateMarker(marker, targetLat, targetLng, duration = 1000) {
        const mId = marker._leaflet_id || Date.now();
        if (activeAnimations.has(mId)) cancelAnimationFrame(activeAnimations.get(mId));
        const start = marker.getLatLng();
        const sx = start.lat, sy = start.lng;
        const tx = targetLat, ty = targetLng;
        const t0 = Date.now();
        function step() {
            const elapsed = Date.now() - t0;
            const p = Math.min(elapsed / duration, 1);
            const ease = p < 0.5 ? 2*p*p : 1 - Math.pow(-2*p+2, 2)/2;
            const cx = sx + (tx - sx)*ease;
            const cy = sy + (ty - sy)*ease;
            marker.setLatLng([cx, cy]);
            if (p < 1) {
                const fid = requestAnimationFrame(step);
                activeAnimations.set(mId, fid);
            } else {
                activeAnimations.delete(mId);
            }
        }
        step();
    }

    async function updateBuses() {
        try {
            const res = await fetch("http://localhost:8080/buses");
            if (!res.ok) return;
            const buses = await res.json();
            if (!Array.isArray(buses)) return;

            const currentIds = new Set(buses.map(b => b.id));

            for (const [id, m] of busMarkers.entries()) {
                if (!currentIds.has(id)) {
                    map.removeLayer(m);
                    busMarkers.delete(id);
                    busPrevPos.delete(id);
                }
            }

            buses.forEach(bus => {
                const id = bus.id;
                const lat = bus.lat, lng = bus.lng;
                const occ = bus.occupancy;

                if (busMarkers.has(id)) {
                    const marker = busMarkers.get(id);
                    const prev = busPrevPos.get(id);
                    if (!prev || prev.lat !== lat || prev.lng !== lng) {
                        animateMarker(marker, lat, lng, 1000);
                    }
                    marker.setStyle({ fillColor: occupancyColor(occ) });
                    marker._popup && marker.setPopupContent(`<strong>Bus ${id}</strong><br>Crowding: ${occ}%`);
                    busPrevPos.set(id, { lat, lng });
                } else {
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: occupancyColor(occ),
                        color: occupancyColor(occ),
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);

                    marker.bindPopup(`<strong>Bus ${id}</strong><br>Crowding: ${occ}%`);
                    busMarkers.set(id, marker);
                    busPrevPos.set(id, { lat, lng });
                }
            });

        } catch (e) {
            console.error("updateBuses error", e);
        }
    }


    async function loadStops() {
        try {
            const res = await fetch("http://localhost:8080/stops");
            if (!res.ok) return;
            const stops = await res.json();
            if (!Array.isArray(stops)) return;

            for (const [k,m] of stopMarkers.entries()) {
                map.removeLayer(m);
            }
            stopMarkers.clear();

            stops.forEach(stop => {
                const marker = L.circleMarker([stop.lat, stop.lng], {
                    radius: 2,
                    fillColor: '#000000',
                    color: '#000000',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker._stopData = stop;

                let routesHTML = "";
                if (stop.routes && stop.routes.length > 0) {
                    routesHTML = `<div style="margin-top:6px;"><strong>Routes:</strong><br>` +
                        stop.routes.map(r => `<span class="route-badge">${r.name}</span>`).join("") +
                        `</div>`;
                }

                marker.bindPopup(`<strong>${stop.name || 'Bus Stop'}</strong><br>ID: ${stop.id}<br>${stop.municipality ? 'Municipality: ' + stop.municipality + '<br>' : ''}${stop.zone ? 'Zone: ' + stop.zone + '<br>' : ''}${routesHTML}`);

                stopMarkers.set(stop.id, marker);
            });

        } catch (e) {
            console.error("loadStops error", e);
        }
    }

    let highlightedStopId = null;

    function resetStopStyle(stopId) {
        const m = stopMarkers.get(stopId);
        if (!m) return;
        m.setStyle({
        radius: 4,
        fillColor: '#000000',
        color: '#000000',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
        });
        m._isHighlighted = false;
    }

    function highlightStopYellow(stopId) {
        if (highlightedStopId && highlightedStopId !== stopId) {
            resetStopStyle(highlightedStopId);
            highlightedStopId = null;
        }
        const m = stopMarkers.get(stopId);
        if (!m) return;
        m.setStyle({
        radius: 8,
        fillColor: '#800080',
        color: '#800080',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.9});
        m._isHighlighted = true;
        highlightedStopId = stopId;
    }

    function checkClosestStop() {
        if (stopMarkers.size === 0) return;
        let nearest = null;
        let minD = Infinity;
        for (const [stopId, m] of stopMarkers.entries()) {
            const d = map.distance([userLocation.lat, userLocation.lng], [m._stopData.lat, m._stopData.lng]);
            if (d < minD) { minD = d; nearest = stopId; }
        }
        if (nearest && minD <= 10) {
            highlightStopYellow(nearest);
        } else if (highlightedStopId) {
            resetStopStyle(highlightedStopId);
            highlightedStopId = null;
        }
    }

    loadStops();
    updateBuses();
    setInterval(updateBuses, 2000);
    setInterval(checkClosestStop, 10);

</script>
</body>
</html>
