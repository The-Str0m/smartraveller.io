<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    const map = L.map('map').setView([61.4971, 23.7526], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);
    
    const markers = new Map();
    const markerPositions = new Map();
    const activeAnimations = new Map();
    const stopMarkers = new Map();

    function animateMarker(marker, targetLat, targetLng, duration = 1000) {
        const markerId = marker._leaflet_id || Date.now();
        

        if (activeAnimations.has(markerId)) {
            cancelAnimationFrame(activeAnimations.get(markerId));
        }
        
        const startPos = marker.getLatLng();
        const startLat = startPos.lat;
        const startLng = startPos.lng;
        const startTime = Date.now();
        
        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            

            const ease = progress < 0.5 
                ? 2 * progress * progress 
                : 1 - Math.pow(-2 * progress + 2, 2) / 2;
            
            const currentLat = startLat + (targetLat - startLat) * ease;
            const currentLng = startLng + (targetLng - startLng) * ease;
            
            marker.setLatLng([currentLat, currentLng]);
            
            if (progress < 1) {
                const frameId = requestAnimationFrame(animate);
                activeAnimations.set(markerId, frameId);
            } else {
                activeAnimations.delete(markerId);
            }
        }
        
        animate();
    }
    
    async function updateMarkers() {
        try {
            const res = await fetch("http://localhost:8080/buses");
            if (!res.ok) {
                console.error(`http error, status - ${res.status}`);
                return;
            }
            const buses = await res.json();
            
            if (!Array.isArray(buses) || buses.length === 0) {
                console.log("no bus data");
                return;
            }
            
            const currentBusIds = new Set(buses.map(bus => bus.id));
            

            for (const [busId, marker] of markers.entries()) {
                if (!currentBusIds.has(busId)) {
                    map.removeLayer(marker);
                    markers.delete(busId);
                    markerPositions.delete(busId);
                }
            }
            

            buses.forEach(bus => {
                if (markers.has(bus.id)) {
                    const marker = markers.get(bus.id);
                    const prevPos = markerPositions.get(bus.id);
                    

                    if (prevPos && (prevPos.lat !== bus.lat || prevPos.lng !== bus.lng)) {
                        animateMarker(marker, bus.lat, bus.lng, 1000);
                    }
                    
                    markerPositions.set(bus.id, { lat: bus.lat, lng: bus.lng });
                } 
                else {

                    const marker = L.marker([bus.lat, bus.lng], {
                        title: `Bus ${bus.id}`
                    }).addTo(map);
                    
                    marker.bindPopup(`Bus ID: ${bus.id}`);
                    markers.set(bus.id, marker);
                    markerPositions.set(bus.id, { lat: bus.lat, lng: bus.lng });
                }
            });
            
            console.log(`updated ${buses.length} bus markers`);
        } 
        catch (error) {
            console.error("error fetching buses - ", error);
        }
    }
    async function loadStops() {
        try {
            const res = await fetch("http://localhost:8080/stops");
            if (!res.ok) {
                console.error(`Error fetching stops, status - ${res.status}`);
                return;
            }
            const stops = await res.json();
            
            if (!Array.isArray(stops) || stops.length === 0) {
                console.log("No stop data available");
                return;
            }
            stopMarkers.forEach((marker) => {
                map.removeLayer(marker);
            });
            stopMarkers.clear();
            
            stops.forEach(stop => {
                const stopMarker = L.circleMarker([stop.lat, stop.lng], {
                    radius: 6,
                    fillColor: '#FF0000',
                    color: '#FFFFFF',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                const popupContent = `
                    <strong>${stop.name || 'Bus Stop'}</strong><br>
                    ID: ${stop.id}<br>
                    ${stop.municipality ? `Municipality: ${stop.municipality}<br>` : ''}
                    ${stop.zone ? `Zone: ${stop.zone}` : ''}
                `;
                stopMarker.bindPopup(popupContent);
                stopMarkers.set(stop.id, stopMarker);
            });
            
            console.log(`Loaded ${stops.length} bus stops`);
        } catch (error) {
            console.error("Error fetching stops:", error);
        }
    }

    loadStops();
    
    setInterval(updateMarkers, 2000);
    updateMarkers();
</script>

</body>
</html>
